package api

import (
	"time"

	"github.com/fabric8-services/fabric8-jenkins-proxy/internal/api/app"
	"github.com/fabric8-services/fabric8-jenkins-proxy/internal/storage"
	"github.com/goadesign/goa"
	log "github.com/sirupsen/logrus"
)

// StatsController implements the stats resource.
type StatsController struct {
	*goa.Controller
	storageService storage.Store
}

// NewStatsController creates a stats controller.
func NewStatsController(service *goa.Service) *StatsController {
	return &StatsController{Controller: service.NewController("StatsController")}
}

// Clear runs the clear action.
func (c *StatsController) Clear(ctx *app.ClearStatsContext) error {
	// StatsController_Clear: start_implement

	// Put your logic here

	res := &app.Stats{}
	return ctx.OK(res)
	// StatsController_Clear: end_implement
}

// Info runs the info action.
func (c *StatsController) Info(ctx *app.InfoStatsContext) error {
	// StatsController_Info: start_implement

	// Put your logic here
	ns := ctx.Namespace
	s, notFound, err := c.storageService.GetStatisticsUser(ns)
	if err != nil {
		if notFound {
			log.Debugf("Did not find data for %s", ns)
		} else {
			log.Error(err) //FIXME
			return ctx.BadRequest(goa.ErrInternal(err))
		}
	}
	count, err := c.storageService.GetRequestsCount(ns)
	if err != nil {
		log.Error(err) //FIXME
	service := goa.New("fabric8-jenkins-proxy-api")

	// Mount middleware
	service.Use(middleware.RequestID())
	service.Use(middleware.LogRequest(true))
	service.Use(middleware.ErrorHandler(service, true))
	service.Use(middleware.Recover())

	// Mount "stats" controller
	c := NewStatsController(service)
	app.MountStatsController(service, c)

	// Start service
	if err := service.ListenAndServe(":8080"); err != nil {
		service.LogError("startup", "err", err)
	}
	service := goa.New("fabric8-jenkins-proxy-api")

	// Mount middleware
	service.Use(middleware.RequestID())
	service.Use(middleware.LogRequest(true))
	service.Use(middleware.ErrorHandler(service, true))
	service.Use(middleware.Recover())

	// Mount "stats" controller
	c := NewStatsController(service)
	app.MountStatsController(service, c)

	// Start service
	if err := service.ListenAndServe(":8080"); err != nil {
		service.LogError("startup", "err", err)
	}
	service := goa.New("fabric8-jenkins-proxy-api")

	// Mount middleware
	service.Use(middleware.RequestID())
	service.Use(middleware.LogRequest(true))
	service.Use(middleware.ErrorHandler(service, true))
	service.Use(middleware.Recover())

	// Mount "stats" controller
	c := NewStatsController(service)
	app.MountStatsController(service, c)

	// Start service
	if err := service.ListenAndServe(":8080"); err != nil {
		service.LogError("startup", "err", err)
	}
	service := goa.New("fabric8-jenkins-proxy-api")

	// Mount middleware
	service.Use(middleware.RequestID())
	service.Use(middleware.LogRequest(true))
	service.Use(middleware.ErrorHandler(service, true))
	service.Use(middleware.Recover())

	// Mount "stats" controller
	c := NewStatsController(service)
	app.MountStatsController(service, c)

	// Start service
	if err := service.ListenAndServe(":8080"); err != nil {
		service.LogError("startup", "err", err)
	}
	service := goa.New("fabric8-jenkins-proxy-api")

	// Mount middleware
	service.Use(middleware.RequestID())
	service.Use(middleware.LogRequest(true))
	service.Use(middleware.ErrorHandler(service, true))
	service.Use(middleware.Recover())

	// Mount "stats" controller
	c := NewStatsController(service)
	app.MountStatsController(service, c)

	// Start service
	if err := service.ListenAndServe(":8080"); err != nil {
		service.LogError("startup", "err", err)
	}
	service := goa.New("fabric8-jenkins-proxy-api")

	// Mount middleware
	service.Use(middleware.RequestID())
	service.Use(middleware.LogRequest(true))
	service.Use(middleware.ErrorHandler(service, true))
	service.Use(middleware.Recover())

	// Mount "stats" controller
	c := NewStatsController(service)
	app.MountStatsController(service, c)

	// Start service
	if err := service.ListenAndServe(":8080"); err != nil {
		service.LogError("startup", "err", err)
	}
	service := goa.New("fabric8-jenkins-proxy-api")

	// Mount middleware
	service.Use(middleware.RequestID())
	service.Use(middleware.LogRequest(true))
	service.Use(middleware.ErrorHandler(service, true))
	service.Use(middleware.Recover())

	// Mount "stats" controller
	c := NewStatsController(service)
	app.MountStatsController(service, c)

	// Start service
	if err := service.ListenAndServe(":8080"); err != nil {
		service.LogError("startup", "err", err)
	}
	service := goa.New("fabric8-jenkins-proxy-api")

	// Mount middleware
	service.Use(middleware.RequestID())
	service.Use(middleware.LogRequest(true))
	service.Use(middleware.ErrorHandler(service, true))
	service.Use(middleware.Recover())

	// Mount "stats" controller
	c := NewStatsController(service)
	app.MountStatsController(service, c)

	// Start service
	if err := service.ListenAndServe(":8080"); err != nil {
		service.LogError("startup", "err", err)
	}
		return ctx.BadRequest(goa.ErrBadRequest(err))
	}

	res := &app.Stats{
		Namespace:   ns,
		Requests:    count,
		LastRequest: time.Unix(s.LastBufferedRequest, 0),
		LastVisit:   time.Unix(s.LastAccessed, 0),
	}
	return ctx.OK(res)
	// StatsController_Info: end_implement
}
